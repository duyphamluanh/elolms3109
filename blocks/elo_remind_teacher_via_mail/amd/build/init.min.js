/*
 * Javascript needed for license tool datatables
 *
 * @package    block_transfer_course
 * @copyright  2018 Kentucky Educational Television
 */

define([
  "jquery",'block_elo_remind_teacher_via_mail/jquery.dataTables','block_elo_remind_teacher_via_mail/dataTables.buttons',
  'block_elo_remind_teacher_via_mail/dataTables.fixedHeader','block_elo_remind_teacher_via_mail/dataTables.select',
  "core/ajax","core/str","core/notification","core/modal_factory","core/modal_events","core/templates",
], function ($,datatables,buttons,dtfixedHeader, select, Ajax, Str, Notification, ModalFactory, ModalEvents, Templates) {
  /**
   * Selectors.
   *
   * @access private
   * @type {Object}
   */

  return {
    init: function (identifier, config) {
      // Cài đặt datatable
      $(document).ready(function () {
        var table;
        table = $('#remindteachertable').DataTable({
          "language": {
            "emptyTable": "No data available in table",
            "searchPanes": {
              "emptyPanes": 'There are no panes to display. :/'
            }
          }, 
          fixedHeader: {
            headerOffset: 25,
            alwaysCloneTop: true
          },
          columnDefs: [{
            "defaultContent": "-",
            "targets": "_all"
          }],
        });
        var table2;
        table2 = $('#emailhistorytable').DataTable({
          "language": {
            "emptyTable": "No data available in table",
            "searchPanes": {
              "emptyPanes": 'There are no panes to display. :/'
            }
          }, 
          fixedHeader: {
            headerOffset: 25,
            alwaysCloneTop: true
          },
          columnDefs: [{
            "defaultContent": "-",
            "targets": "_all"
          }],
          "order": [[ 4, "desc" ]]
        });

        $('#myTab a').on('click', function (e) {
          e.preventDefault()
          $(this).tab('show');
        })    

        $('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {    
          table.fixedHeader.disable();
          table2.fixedHeader.disable();
          if (e.target.hash == '#block_elo_remind_teacher_via_mail-main'){
            table.fixedHeader.enable().fixedHeader.adjust(); 
          }
          else if (e.target.hash == '#block_elo_remind_teacher_via_mail-history'){  	  
            table2.fixedHeader.enable().fixedHeader.adjust();
          }
        });
        
      });
      // Xử lý sự kiện send mail
      $("button[id*='sendmail_']").click(function(){
        var teacherid = $(this).attr("tid");
        // Show spinner
        $("#sendmail_" + teacherid + " i").removeClass("hide");

        var request = {
          methodname: 'block_elo_remind_teacher_via_mail_mailtouser',
          args: {teacherid: teacherid},
        };
        Ajax.call([request])[0].then(function(response) {
          response = JSON.parse(response.elodata);
          if (response.success !== undefined) {
            // Remove spinner
            $("#sendmail_" + teacherid + " i").addClass("hide");
            // Disable send button
            $("#sendmail_" + teacherid).prop('disabled', true);
            // Hiển thị thời gian gửi gần nhất từ response
            var timenow = response.success['data'].listusers[0].lastsentmail;
            $("#latestSent_" + teacherid).text("Lần gửi gần nhất: " + timenow);
          }
          else if (response.error !== undefined) {
            // console.log("Send failed");
            $("#sendmail_" + teacherid + " i").addClass("hide");
          }
          return;
        }).catch(function(ex){
            console.log(ex);
            Notification.exception(ex);
        });

      });
      
    },

  };
});
